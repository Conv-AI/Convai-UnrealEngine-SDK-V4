name: Build and Release Unreal Plugin

on:
  push:
    branches:
      - main
      - staging
      - beta
  workflow_dispatch:

# Explicitly grant permissions to GITHUB_TOKEN
permissions:
  contents: write    # Required for creating releases and pushing tags
  actions: read      # Required for workflow execution
  checks: read       # Required for status checks

jobs:
  checkout-code:
    runs-on: UE-Dev-Runner
    outputs:
      version_name: ${{ steps.extract_version.outputs.version_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Extract version from .uplugin
        id: extract_version
        run: |
          $plugin = Get-Content "ConvAI.uplugin" | ConvertFrom-Json
          $plugin_version = $plugin.VersionName
          echo "::set-output name=version_name::$plugin_version"
        shell: pwsh

  check-version:
    needs: checkout-code
    runs-on: UE-Dev-Runner
    outputs:
      release_exists: ${{ steps.check_release.outputs.release_exists }}  # Define job output based on step output
    steps:
      - name: Check if release exists using GitHub API
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Construct release name
          $release_name = "Convai Unreal Engine SDK Version ${{ needs.checkout-code.outputs.version_name }}"

          # Fetch releases
          $releases = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases" -Headers @{ Authorization = "Bearer $env:GH_TOKEN" }

          # Check if release already exists
          $release_exists = $false
          foreach ($release in $releases) {
              if ($release.name -eq $release_name) {
                  $release_exists = $true
                  break
              }
          }

          # Set step output
          if ($release_exists) {
              echo "::set-output name=release_exists::true"
          } else {
              echo "::set-output name=release_exists::false"
          }
        shell: pwsh

  build-and-package:
    needs: check-version
    runs-on: UE-Dev-Runner
    if: needs.check-version.outputs.release_exists == 'false'
    steps:
      - name: Debug output
        run: |
          echo "Release exists output: ${{ needs.check-version.outputs.release_exists }}"

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Define paths
        id: paths
        run: |
          $repo_name = "${{ github.event.repository.name }}"
          $ue_root = "E:/Software"
          $output_root = "E:/Output/${repo_name}_Binaries"
          $plugin_path = "${{ github.workspace }}/ConvAI.uplugin"
          echo "::set-output name=ue_root::$ue_root"
          echo "::set-output name=output_root::$output_root"
          echo "::set-output name=plugin_path::$plugin_path"
        shell: pwsh

      - name: Extract and Copy Dependencies
        run: |
          try {
            $dependencies_dir = "E:/Dependencies_V4"
            $plugin_dir = "${{ github.workspace }}"
            $content_zip = "$dependencies_dir/Content.zip"
            $thirdparty_zip = "$dependencies_dir/ThirdParty.zip"
            $plugin_content_dir = "$plugin_dir/Content"
            $plugin_thirdparty_dir = "$plugin_dir/Source/ThirdParty"
            if (Test-Path $plugin_content_dir) {
                Remove-Item -Recurse -Force $plugin_content_dir
            }
            if (Test-Path $plugin_thirdparty_dir) {
                Remove-Item -Recurse -Force $plugin_thirdparty_dir
            }
            Expand-Archive -Path $content_zip -DestinationPath $plugin_dir
            Expand-Archive -Path $thirdparty_zip -DestinationPath "$plugin_dir/Source"
            Write-Host "Dependencies extracted and copied successfully."
          } catch {
            Write-Host "Failed to extract and copy dependencies. Error: $_"
            exit 1
          }
        shell: pwsh

      - name: Build and package for Unreal versions 5.2 to 5.6
        run: |
          try {
            $versions = @("5.6", "5.5", "5.4","5.3","5.2")
            foreach ($version in $versions) {
                $ue_version_path = "${{ steps.paths.outputs.ue_root }}/UE_$version"
                $output_path = "${{ steps.paths.outputs.output_root }}/V$version/Convai"
                if (Test-Path $output_path) {
                    Remove-Item -Recurse -Force -Path "$output_path/*"
                } else {
                    New-Item -Path $output_path -ItemType Directory
                }
                Write-Host "Starting packaging for UE_$version..."
                $uat_path = "$ue_version_path/Engine/Build/BatchFiles/RunUAT.bat"
                & $uat_path BuildPlugin -Plugin="${{ steps.paths.outputs.plugin_path }}" -Package="$output_path" -Rocket -TargetPlatforms=Win64
                if ($LASTEXITCODE -ne 0) {
                    Write-Host "Packaging failed for UE_$version. Exit code: $LASTEXITCODE"
                    exit $LASTEXITCODE
                }
                Write-Host "Packaged for UE_$version at $output_path"
            }
          } catch {
            Write-Host "Packaging failed for Unreal Engine version $version. Error: $_"
            exit 1
          }
        shell: pwsh

      - name: Test packaging for Windows UE 5.6
        run: |
          try {
            $ue_version_path = "${{ steps.paths.outputs.ue_root }}/UE_5.6"
            $output_path = "${{ steps.paths.outputs.output_root }}/V5.6"
            $test_project_path = "E:/Software/TestProject"
            $plugin_folder = "$test_project_path/Plugins"
            if (Test-Path $plugin_folder) {
                Remove-Item -Recurse -Force $plugin_folder
            }
            New-Item -Path $plugin_folder -ItemType Directory
            Copy-Item -Recurse -Force "$output_path/Convai" $plugin_folder
            Write-Host "Copied the plugin to the TestProject."
            $uat_path = "$ue_version_path/Engine/Build/BatchFiles/RunUAT.bat"
            Write-Host "Starting project packaging for Unreal 5.6..."
            & $uat_path BuildCookRun `
            -project="$test_project_path/TestProject.uproject" `
            -noP4 -utf8output -platform=Win64 -clientconfig=Shipping -cook -stage -package -compressed -pak `
            -build -prereqs -distribution -archive `
            -archivedirectory="$test_project_path/Windows"
            if ($LASTEXITCODE -ne 0) {
                Write-Host "Packaging failed for UE_$version. Exit code: $LASTEXITCODE"
                exit $LASTEXITCODE
            }
            Write-Host "Project packaging completed successfully for Unreal 5.6"
          } catch {
            Write-Host "Project packaging failed for Unreal Engine 5.6. Error: $_"
            exit 1
          }
        shell: pwsh

      - name: Zip Plugin for each version
        run: |
          try {
            $versions = @("5.6","5.5","5.4","5.3","5.2")
            foreach ($version in $versions) {
                $output_path = "${{ steps.paths.outputs.output_root }}/V$version"
                Compress-Archive -Path "$output_path" -DestinationPath "$output_path.zip" -Force
                Write-Host "Zipped plugin for UE$version at $output_path.zip"
            }
          } catch {
            Write-Host "Zipping failed. Error: $_"
            exit 1
          }
        shell: pwsh

  compress-and-release:
    needs: [checkout-code, check-version, build-and-package]
    runs-on: UE-Dev-Runner
    if: needs.check-version.outputs.release_exists == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract release notes
        id: extract_notes
        run: |
          $version = "${{ needs.checkout-code.outputs.version_name }}"
          $changelog = Get-Content "CHANGELOG.md"
          $notes = $changelog -split "\r?\n" | Select-String -Pattern "^# Release $version" -Context 0,10 | ForEach-Object { $_.Context.PostContext }
          $notes = $notes -join "`n"
          echo "::set-output name=release_notes::$notes"
        shell: pwsh

      - name: Create Git tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "=== Git Tag Creation Debug Info ==="
          Write-Host "Repository: ${{ github.repository }}"
          Write-Host "Actor: ${{ github.actor }}"
          Write-Host "Event: ${{ github.event_name }}"
          Write-Host "Ref: ${{ github.ref }}"

          # Check if token is available (without exposing it)
          if ($env:GITHUB_TOKEN) {
            Write-Host "✓ GITHUB_TOKEN is available (length: $($env:GITHUB_TOKEN.Length))"
          } else {
            Write-Host "✗ GITHUB_TOKEN is not available"
            exit 1
          }

          Write-Host "Configuring git user..."
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

          Write-Host "Current git remote URL:"
          git remote get-url origin

          Write-Host "Configuring git remote for token authentication..."
          git remote set-url origin https://x-access-token:$env:GITHUB_TOKEN@github.com/${{ github.repository }}.git

          Write-Host "Updated git remote URL (token masked):"
          git remote get-url origin | ForEach-Object { $_ -replace $env:GITHUB_TOKEN, "***TOKEN***" }

          $version = "${{ needs.checkout-code.outputs.version_name }}"
          Write-Host "Version to tag: '$version'"
          if (-not $version) {
            Write-Host "✗ Version is empty!"
            exit 1
          }

          Write-Host "Creating git tag: $version"
          git tag $version
          if ($LASTEXITCODE -ne 0) {
            Write-Host "⚠️ Tag creation failed - checking if tag already exists..."
            $existingTag = git tag -l $version
            if ($existingTag) {
              Write-Host "✓ Tag '$version' already exists locally, continuing..."
            } else {
              Write-Host "✗ Failed to create tag for unknown reason"
              exit 1
            }
          } else {
            Write-Host "✓ Successfully created tag locally"
          }

          Write-Host "Checking if tag exists locally:"
          git tag -l $version

          Write-Host "Pushing tag to remote..."
          git push origin $version
          if ($LASTEXITCODE -ne 0) {
            Write-Host "⚠️ Tag push failed - checking if tag already exists on remote..."

            # Check if the tag exists on remote
            $remoteTag = git ls-remote --tags origin $version
            if ($remoteTag) {
              Write-Host "✓ Tag '$version' already exists on remote, continuing..."
            } else {
              Write-Host "✗ Failed to push tag and tag doesn't exist on remote"
              Write-Host "Git status:"
              git status
              Write-Host "Git remote -v:"
              git remote -v
              exit 1
            }
          } else {
            Write-Host "✓ Successfully pushed tag to remote"
          }

          Write-Host "✓ Successfully created and pushed tag: $version"
        shell: pwsh

      - name: Confirm Git tag exists
        run: |
          $version = "${{ needs.checkout-code.outputs.version_name }}"
          if (-not $version) { Write-Host "Version is empty!"; exit 1 }
          git fetch --tags
          git show-ref --tags | Select-String $version
        shell: pwsh

      - name: Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.checkout-code.outputs.version_name }}
          name: "Convai Unreal Engine SDK Version ${{ needs.checkout-code.outputs.version_name }}"
          body: ${{ steps.extract_notes.outputs.release_notes }}
          files: |
            E:/Output/${{ github.event.repository.name }}_Binaries/V5.6.zip
            E:/Output/${{ github.event.repository.name }}_Binaries/V5.5.zip
            E:/Output/${{ github.event.repository.name }}_Binaries/V5.4.zip
            E:/Output/${{ github.event.repository.name }}_Binaries/V5.3.zip
            E:/Output/${{ github.event.repository.name }}_Binaries/V5.2.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}